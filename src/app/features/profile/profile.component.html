<main *ngIf="profile">
    <header class="pattern-header">
        <div class="header-actions">
            <button class="action-chip white" [routerLink]="['/contracts']">
                üìÑ Contratos
            </button>
            
            <button class="action-chip white" (click)="toggleEdit()" *ngIf="!isEditing">
                ‚úèÔ∏è Editar
            </button>
            <button class="action-chip save" (click)="save()" *ngIf="isEditing" [disabled]="isLoading">
                {{ isLoading ? '...' : 'üíæ Salvar' }}
            </button>
        </div>
    </header>

    <section class="profile-content">
        <div class="avatar-wrapper">
            <img [src]="profile.avatarUrl" alt="Profile">
            <button class="camera-btn" *ngIf="isEditing">üì∑</button>
        </div>

        <div class="main-info">
            <h2 *ngIf="!isEditing">{{ profile.name }}</h2>
            <input *ngIf="isEditing" [(ngModel)]="editForm.name" class="edit-input name-input">

            <p class="email">{{ profile.email }}</p>
        </div>

        <div class="stats-row">
            <div class="stat">
                <span class="value">‚≠ê {{ profile.rating | number:'1.1-1' }}</span>
                <span class="label">Avalia√ß√£o</span>
            </div>
            <div class="divider"></div>
            <div class="stat">
                <span class="value">{{ profile.needsCount }}</span>
                <span class="label">Necessidades</span>
            </div>
            <div class="divider"></div>
            <div class="stat">
                <span class="value">{{ profile.servicesCount }}</span>
                <span class="label">Presta√ß√µes</span>
            </div>
        </div>

        <div class="location-status">
            <div class="loc-info">
                <span>üìç</span>
                <span *ngIf="!isEditing">{{ profile.location }}</span>
                <input *ngIf="isEditing" [(ngModel)]="editForm.location" class="edit-input">
            </div>
            
            <button class="status-badge" 
                    [class.available]="profile.status === 'AVAILABLE'"
                    [class.busy]="profile.status === 'BUSY'"
                    (click)="openCalendar()">
                {{ profile.status === 'AVAILABLE' ? 'Dispon√≠vel' : 'Indispon√≠vel' }} ‚öôÔ∏è
            </button>
        </div>

        <div class="section">
            <h3>Sobre mim</h3>
            <p *ngIf="!isEditing">{{ profile.bio }}</p>
            <textarea *ngIf="isEditing" [(ngModel)]="editForm.bio" rows="3" class="edit-input"></textarea>
        </div>

        <div class="section">
            <h3>Habilidades</h3>
            <div class="skills-container">
                @for (skill of profile.skills; track $index) {
                    <span class="skill-tag">üè∑Ô∏è {{ skill }}</span>
                }
                <button *ngIf="isEditing" class="add-skill">+</button>
            </div>
        </div>

        <div class="section">
            <div class="profile-tabs">
                <button 
                    class="p-tab" 
                    [class.active]="activeProfileTab === 'MY_NEEDS'"
                    (click)="activeProfileTab = 'MY_NEEDS'">
                    Publicadas ({{ profile.myNeeds.length }})
                </button>
                <button 
                    class="p-tab" 
                    [class.active]="activeProfileTab === 'APPLICATIONS'"
                    (click)="activeProfileTab = 'APPLICATIONS'">
                    Candidaturas ({{ profile.myApplications.length }})
                </button>
            </div>

            @if (activeProfileTab === 'MY_NEEDS') {
                @for (item of profile.myNeeds; track item.id) {
                    <div class="mini-card">
                        <div class="mini-header">
                            <img [src]="item.contractorAvatar" class="mini-avatar">
                            <div class="mini-info">
                                <strong>{{ item.contractorName }}</strong>
                                <small>{{ item.timePosted }}</small>
                            </div>
                            <strong class="price">R$ {{ item.price }}</strong>
                        </div>
                        <p class="mini-title">{{ item.title }}</p>
                    </div>
                }
            }

            @if (activeProfileTab === 'APPLICATIONS') {
                @for (app of profile.myApplications; track app.id) {
                    <div class="mini-card application-card">
                        <div class="mini-header">
                            <img [src]="app.contractorAvatar" class="mini-avatar">
                            <div class="mini-info">
                                <strong>{{ app.contractorName }}</strong>
                                <div class="status-tag pending">Aguardando</div>
                            </div>
                            <strong class="price">R$ {{ app.price }}</strong>
                        </div>
                        <p class="mini-title">{{ app.title }}</p>
                    </div>
                }
                @if (profile.myApplications.length === 0) {
                    <p style="text-align: center; color: #999; font-size: 12px; margin-top: 10px;">
                        Voc√™ ainda n√£o se candidatou a nenhuma vaga.
                    </p>
                }
            }
        </div>
    </section>

    <nav class="bottom-nav">
        <a [routerLink]="['/home']" class="nav-item">üè†</a>
        <a [routerLink]="['/home']" class="nav-item">üîç</a>
        <a [routerLink]="['/chat']" class="nav-item">üí¨</a>
        <a class="nav-item active">üë§</a>
    </nav>

    <div class="modal-overlay" *ngIf="showCalendarModal">
        <div class="modal-card">
            <div class="modal-header-row">
                <h3>Minha Disponibilidade</h3>
                <button class="close-btn" (click)="closeCalendar()">‚úï</button>
            </div>

            <div class="global-status-box" [class.busy]="tempStatus === 'BUSY'" (click)="toggleGlobalStatus()">
                <div class="status-info">
                    <span class="label">Status Geral</span>
                    <span class="status-text">{{ tempStatus === 'AVAILABLE' ? 'Dispon√≠vel para trabalho' : 'Indispon√≠vel (F√©rias/Folga)' }}</span>
                </div>
                <div class="toggle-switch">
                    <div class="switch-ball"></div>
                </div>
            </div>

            <div class="calendar-wrapper" [class.disabled]="tempStatus === 'BUSY'">
                
                <div class="calendar-nav">
                    <button (click)="changeMonth(-1)">‚Äπ</button>
                    <span>{{ currentDate | date:'MMMM yyyy' }}</span>
                    <button (click)="changeMonth(1)">‚Ä∫</button>
                </div>

                <div class="weekdays-grid">
                    @for (d of weekDays; track $index) {
                        <span>{{ d }}</span>
                    }
                </div>

                <div class="days-grid">
                    @for (item of calendarDays; track $index) {
                        <div class="day-cell" 
                             [class.empty]="!item.day"
                             [class.blocked]="item.fullDate && tempBlockedDates.includes(item.fullDate!)"
                             (click)="toggleDate(item.fullDate)">
                            {{ item.day }}
                        </div>
                    }
                </div>
                
                <div class="legend">
                    <span class="dot red"></span> Dias bloqueados
                </div>
            </div>

            <button class="save-agenda-btn" (click)="saveAvailability()">
                Salvar Altera√ß√µes
            </button>
        </div>
    </div>
</main>